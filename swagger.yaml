openapi: 3.0.0
info:
  title: Auth API
  version: 1.0.0
  description: Authentication API documentation
  contact:
    email: loinguyenlamthanh@gmail.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
security:
  - bearerAuth: []
tags:
  - name: Index
    description: Index related endpoints
  - name: Migrate
    description: Migrate related endpoints
  - name: AuditLog
    description: AuditLog related endpoints
  - name: Auth
    description: Auth related endpoints
  - name: Franchise
    description: Franchise related endpoints
  - name: Role
    description: Role related endpoints
  - name: User
    description: User related endpoints
  - name: UserFranchiseRole
    description: UserFranchiseRole related endpoints
  - name: Category Franchise
    description: Franchise menu category endpoints
  - name: Category
    description: Category related endpoints
  - name: Product
    description: Product related endpoints
paths:
  /api/auth/register:
    post:
      summary: Register new user
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@gmail.com
                password:
                  type: string
                  minLength: 6
                  example: 123456
      responses:
        '200':
          description: Register successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      _id:
                        type: string
                        example: 6786117ca2e8a8cfbf2032bf
                      email:
                        type: string
                        example: user@gmail.com
                      is_verified:
                        type: boolean
                        example: false
                      created_at:
                        type: string
                        format: date-time
                      updated_at:
                        type: string
                        format: date-time
  /api/auth/verify-token:
    post:
      summary: Verify Token for new user
      security:
        - Bearer: []
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  example: a6b29f364e255de7815d265c8708bb28
      responses:
        '200':
          description: Token verified
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    nullable: true
                    example: null
  /api/auth/resend-token:
    post:
      summary: Resend verification token via email
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '200':
          description: Verification token resent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    nullable: true
                    example: null
        '400':
          description: Invalid email or user already verified
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: User already verified or email not found
  /api/auth:
    post:
      summary: Login user (Set HttpOnly cookies)
      description: >
        Login for normal web usage.

        - Access token and refresh token are set automatically as HttpOnly
        cookies.

        - Client does NOT receive tokens in response body.
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: 12345678
      responses:
        '200':
          description: Login successful. Tokens are set in HttpOnly cookies.
          headers:
            Set-Cookie:
              description: |
                HttpOnly cookies containing access_token and refresh_token.
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '400':
          description: Invalid email or password
        '401':
          description: Unauthorized
        '403':
          description: User is blocked or deleted
    get:
      summary: Get current logged-in user info
      tags:
        - Auth
      description: >
        Get information of the currently logged-in user. Authentication is
        handled via HttpOnly access_token cookie.
      responses:
        '200':
          description: Successfully retrieved user information
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        example: 64f1c2a9e1a123456789abcd
                      email:
                        type: string
                        example: user@example.com
                      role:
                        type: string
                        example: customer
        '401':
          description: Unauthorized - user is not logged in or token is invalid
  /api/auth/login-swagger:
    post:
      summary: Login user (Return JWT tokens for Swagger / API testing)
      description: |
        Login endpoint for Swagger, Postman, or external clients.
        - Tokens are returned in response body.
        - No cookies are set.
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: 12345678
      responses:
        '200':
          description: Login successful. Tokens are returned in response body.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      accessToken:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      refreshToken:
                        type: string
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          description: Invalid email or password
        '401':
          description: Unauthorized
        '403':
          description: User is blocked or deleted
  /api/auth/logout:
    post:
      summary: Logout user
      description: |
        Logout endpoint for both browser and API clients.

        - If logged in via **cookie**: cookies will be cleared.
        - If logged in via **Authorization header**: token will be revoked.

        This endpoint requires authentication.
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: null
                    example: null
        '401':
          description: Unauthorized (missing or invalid token)
  /api/auth/forgot-password:
    put:
      summary: Forgot password - generate and send new password via email
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '200':
          description: New password has been sent to user's email
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    nullable: true
                    example: null
        '400':
          description: User not found, not verified, or blocked
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: User does not exist or is not eligible for password reset
        '500':
          description: Failed to send email
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Failed to send reset password email
  /api/auth/change-password:
    put:
      summary: Change password for logged-in user
      security:
        - Bearer: []
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - old_password
                - new_password
              properties:
                old_password:
                  type: string
                  example: oldPassword123
                new_password:
                  type: string
                  example: newStrongPassword456
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    nullable: true
                    example: null
        '400':
          description: Invalid input or business rule violation
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Old password is required
        '401':
          description: Unauthorized - old password incorrect or invalid token
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Old password is incorrect
        '403':
          description: Forbidden - user is blocked or not allowed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Cannot change password for default admin account
  /:
    get:
      summary: Index API - check server status
      tags:
        - Index
      responses:
        '200':
          description: Server is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: API is running
  /api/roles/migrate:
    get:
      summary: Migrate default roles
      tags:
        - Role
      security:
        - bearerAuth: []
      description: >
        Initialize or migrate default system roles.

        This endpoint is typically used by admin during system setup or
        deployment.
      responses:
        '200':
          description: Roles migrated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: 'null'
                    example: null
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '500':
          description: Internal server error
  /api/roles:
    get:
      summary: Get all roles
      tags:
        - Role
      security:
        - bearerAuth: []
      description: Retrieve all roles in the system.
      responses:
        '200':
          description: Get roles successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        code:
                          type: string
                          example: ADMIN
                        name:
                          type: string
                          example: Administrator
                        description:
                          type: string
                          example: System administrator role
                        scope:
                          type: string
                          enum:
                            - GLOBAL
                            - FRANCHISE
                          example: GLOBAL
                        created_at:
                          type: string
                          format: date-time
                          example: '2025-07-01T08:00:00Z'
                        updated_at:
                          type: string
                          format: date-time
                          example: '2025-07-01T08:00:00Z'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
  /api/users:
    post:
      summary: Create new user (Admin only)
      tags:
        - User
      security:
        - Bearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: staff01@gmail.com
                password:
                  type: string
                  minLength: 8
                  example: Password@123
                name:
                  type: string
                  example: Staff Nguyen
                role:
                  type: string
                  example: STAFF
      responses:
        '200':
          description: User created successfully
        '401':
          description: Unauthorized - missing or invalid token
        '403':
          description: Forbidden - only admin can create user
  /api/users/{id}:
    get:
      summary: Get user by id
      tags:
        - User
      security:
        - Bearer: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: User ID
          example: 6786117ca2e8a8cfbf2032bf
      responses:
        '200':
          description: Get user information successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        example: 6786117ca2e8a8cfbf2032bf
                      email:
                        type: string
                        example: staff01@gmail.com
                      role:
                        type: string
                        example: staff
                      name:
                        type: string
                        example: Staff Nguyen
                      phone:
                        type: string
                        example: '0909123456'
        '401':
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Unauthorized
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: User not found
